---

# This task necessary because data structure is different

- name: run postgres query fileglob iteration
  postgresql_query:
    login_host: "{{sql_host|default(omit)}}"
    login_user: "{{sql_con_args['user']}}"
    login_password: "{{sql_con_args['password']}}"
    login_unix_socket: "{{sql_con_args['socket']|default(omit)}}"
    ssl_mode: "{{sql_con_args['ssl_mode']|default(omit)}}"
    ssl_rootcert: "{{sql_con_args['ssl_rootcert']|default(omit)}}"

    db: "{{sql_db}}"
    query: "{{item}}"
    # named_args: "{{sql_facts|default(omit)}}"
  delegate_to: localhost
  run_once: True

# log job
- name: log query result to sql '{{sql_history_logfile}}'
  lineinfile:
    create: yes
    line: "{{item}}"
    dest: "{{sql_history_logfile}}"
